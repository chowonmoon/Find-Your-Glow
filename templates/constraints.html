{% extends "base.html" %}
{% block title %}Detail Check{% endblock %}

{% block content %}

<style>
    /* 1. ì•Œì•½ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ì§ëŒ€ê¸° ì œê±° + íë¦¬ê²Œ + ì•Œì•½ ëª¨ì–‘) */
    .face-option input:disabled + .choice-box,
    .face-option.disabled .choice-box {
        text-decoration: none !important;
        opacity: 0.35;
        background: #f9f9f9;
        color: #ccc;
        border-color: #eee;
        cursor: not-allowed;
    }
    .face-option input:disabled + .choice-box span,
    .face-option.disabled .choice-box span {
        text-decoration: none !important;
    }

    /* 2. ì„¹ì…˜ ì œëª© (ë°‘ì¤„ ì œê±°) */
    .section-label-clean {
        font-family: 'S-CoreDream-3Light', sans-serif;
        font-size: 0.95rem;
        font-weight: 600;
        color: #111;
        text-align: center;
        margin: 0 auto 16px;
    }

    /* 3. âœ… ê°œì„ ëœ ì•Œë¦¼ ë°•ìŠ¤ (ë†’ì´ ì¶•ì†Œ + ì •ë ¬ êµì • + ì¤„ë°”ê¿ˆ ë°©ì§€) */
    .info-box {
        background-color: #fff8f8;
        border: 1px dashed #D48896;
        color: #b05c6e;
        padding: 14px 10px;
        margin: 0 auto 24px;
        border-radius: 12px;
        max-width: 400px;

        /* ë‚´ë¶€ ìš”ì†Œ ì™„ë²½ ì¤‘ì•™ ì •ë ¬ */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        word-break: keep-all; /* ë‹¨ì–´ ë‹¨ìœ„ ì¤„ë°”ê¿ˆ */
    }

    /* ì²´í¬ë°•ìŠ¤ ìˆ¨ê¸°ê¸° */
    .constraint-checkbox { display: none; }

    /* ì•Œì•½ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (choice-box ì¬í™œìš©) */
    .constraint-pill-style {
        border: 1px solid #ddd;
        background: #fff;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* ì²´í¬ëœ ìƒíƒœ */
    input:checked + .constraint-pill-style {
        background: #111;
        border-color: #111;
        color: #fff;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    input:checked + .constraint-pill-style span {
        color: #fff;
    }
</style>

<div class="terminal-card">

    <div class="card-header" style="border-bottom: none; padding-bottom: 0;">
        <span style="font-family: 'Pretendard'; font-size: 0.8rem; letter-spacing: 2px; color: #999;">STEP 05</span>
    </div>

    <div class="step-block step-block-header">
        <h2 class="sub-title" style="font-family: 'S-CoreDream-Bold'; margin-top: 0; margin-bottom: 15px;">
            DETAIL POINTS
        </h2>

        <div class="info-box">
            <div style="font-size: 0.95rem; margin-bottom: 4px; line-height: 1.4;">
                <span style="font-weight: 700;">ğŸ’¡ Notice</span>
                <span style="margin: 0 4px; color: #eec1c1;">|</span>
                ì„ íƒí•˜ì‹  ì¡°ê±´ì˜ <strong>ê°€ëŠ¥í•œ ì˜µì…˜</strong>ë§Œ í™œì„±í™”ë©ë‹ˆë‹¤.
            </div>

            <div style="font-size: 0.75rem; opacity: 0.8;">
                (ì„ íƒí•˜ì§€ ì•Šì•„ë„ ê²°ê³¼ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤)
            </div>
        </div>
    </div>

    <form id="constraints_reload_form" action="/constraints" method="POST">
        <input type="hidden" name="tone" value="{{ tone }}">
        <input type="hidden" name="nickname" value="{{ nickname }}">
        <input type="hidden" name="occasion" value="{{ occasion }}">
        <input type="hidden" name="face_shape" value="{{ face_shape }}">
        <input type="hidden" name="tab_mode" value="{{ tab_mode }}">
        <input type="hidden" name="moods" value="{{ moods }}">
        <input type="hidden" name="tags" value="{{ tags }}">
        <input type="hidden" name="style_tag" value="{{ style_tag }}">
        <input type="hidden" name="constraints" id="reload_constraints_field">
    </form>

    <form id="final_submit_form" action="/result" method="POST" class="card-body" style="padding-top: 0;">
        <input type="hidden" name="tone" value="{{ tone }}">
        <input type="hidden" name="nickname" value="{{ nickname }}">
        <input type="hidden" name="occasion" value="{{ occasion }}">
        <input type="hidden" name="face_shape" value="{{ face_shape }}">
        <input type="hidden" name="tab_mode" value="{{ tab_mode }}">
        <input type="hidden" name="moods" value="{{ moods }}">
        <input type="hidden" name="tags" value="{{ tags }}">
        <input type="hidden" name="style_tag" value="{{ style_tag }}">
        <input type="hidden" name="constraints" id="final_constraints_field">

        <div class="step-block step-block-choice">

            <div class="constraint-section">
                <h3 class="section-label-clean">ë‚˜ì˜ ëˆˆë§¤</h3>
                <div class="constraint-grid" style="display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;">
                    {% for tag in ["#ë¬´ìŒ", "#ì†ìŒ", "#ì• êµì‚´"] %}
                    <label class="face-option" style="width: auto; margin-bottom: 0;">
                        <input type="checkbox" name="eye_features" value="{{ tag }}"
                               class="constraint-checkbox"
                               {% if (available_tags is not defined) or (not available_tags) or (tag not in available_tags) %}
                                   disabled
                               {% endif %}
                               {% if tag in selected_constraints %}checked{% endif %}>

                        <div class="choice-box constraint-pill-style" style="padding: 10px 20px; border-radius: 50px; min-width: 80px;">
                            <span class="face-label" style="font-size:0.9rem; margin:0;">{{ tag }}</span>
                        </div>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <div class="constraint-gap" style="height: 25px;"></div>

            <div class="constraint-section">
                <h3 class="section-label-clean">ì„ í˜¸ ìŠ¤íƒ€ì¼</h3>
                <div class="constraint-grid" style="display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;">
                    {% for tag in ["#ë…¸íŒŒë°", "#ë…¸ì•„ì´ë¼ì¸", "#ì˜¤ë²„ë¦½"] %}
                    <label class="face-option" style="width: auto; margin-bottom: 0;">
                        <input type="checkbox" name="makeup_prefs" value="{{ tag }}"
                               class="constraint-checkbox"
                               {% if (available_tags is not defined) or (not available_tags) or (tag not in available_tags) %}
                                   disabled
                               {% endif %}
                               {% if tag in selected_constraints %}checked{% endif %}>

                        <div class="choice-box constraint-pill-style" style="padding: 10px 20px; border-radius: 50px; min-width: 80px;">
                            <span class="face-label" style="font-size:0.9rem; margin:0;">{{ tag }}</span>
                        </div>
                    </label>
                    {% endfor %}
                </div>
            </div>

        </div>

        <p class="helper-text hidden" id="no-available-msg" style="margin-top: 30px; color: #999; text-align: center;">
            í˜„ì¬ ì„ íƒ ê°€ëŠ¥í•œ ì˜µì…˜ì´ ì—†ì–´ìš”!<br>
            ë°”ë¡œ ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”
        </p>

        <div class="card-footer" style="justify-content: center; border: none; padding-top: 35px;">
            <button type="submit" class="btn-primary">RESULT</button>
        </div>
    </form>

</div>

<div id="loading-overlay" class="loading-overlay hidden">
  <div class="loading-box">
    <div class="spinner"></div>
    <p class="loading-text">ê²°ê³¼ ìƒì„±í•˜ëŠ” ì¤‘...</p>
    <span class="loading-sub">ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” âœ¨</span>
  </div>
</div>

<script>
    const reloadForm = document.getElementById("constraints_reload_form");
    const finalForm = document.getElementById("final_submit_form");
    const loadingOverlay = document.getElementById("loading-overlay");
    const loadingText = document.querySelector(".loading-text");

    // âœ… ë¡œë”© ë©˜íŠ¸ ë¦¬ìŠ¤íŠ¸ (ì›€ì§ì´ëŠ” íš¨ê³¼!)
    const messages = [
        "ì‚¬ìš©ì ë°ì´í„° ë¶„ì„ ì¤‘... ğŸ”",
        "í¼ìŠ¤ë„ ì»¬ëŸ¬ & ë¬´ë“œ ë§¤ì¹­ ì¤‘... ğŸ¨",
        "ì–´ìš¸ë¦¬ëŠ” ë©”ì´í¬ì—… ì°¾ëŠ” ì¤‘... ğŸ’„",
        "ìµœì¢… ë¦¬í¬íŠ¸ ì‘ì„± ì¤‘... âœ¨",
        "ê±°ì˜ ë‹¤ ëì–´ìš”! ì¡°ê¸ˆë§Œ ë”... ğŸƒâ€â™€ï¸"
    ];

    function startLoadingAnimation() {
        loadingOverlay.classList.remove("hidden");

        let msgIndex = 0;
        // 1.5ì´ˆë§ˆë‹¤ ë©˜íŠ¸ ë³€ê²½
        setInterval(() => {
            msgIndex = (msgIndex + 1) % messages.length;
            loadingText.innerText = messages[msgIndex];
        }, 1500);
    }

    function collectSelected() {
        const list = [];
        document.querySelectorAll(".constraint-checkbox:checked").forEach(c => {
            list.push(c.value);
        });
        return list.join(",");
    }

    // ì²´í¬ ë³€í™” â†’ reload
    document.querySelectorAll(".constraint-checkbox").forEach(chk => {
        chk.addEventListener("change", () => {
            document.getElementById("reload_constraints_field").value = collectSelected();
            reloadForm.submit();
        });
    });

    // ìµœì¢… ì œì¶œ
    finalForm.addEventListener("submit", () => {
        document.getElementById("final_constraints_field").value = collectSelected();
        startLoadingAnimation(); // âœ… ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    });

    // ë¹„í™œì„±í™” ì²´í¬
    const allInputs = document.querySelectorAll(".constraint-checkbox");
    const enabledInputs = [...allInputs].filter(input => !input.disabled);

    if (enabledInputs.length === 0) {
        document.getElementById("no-available-msg").classList.remove("hidden");
    }
</script>

{% endblock %}